CREATE TABLE UPW14_WOS_MATCHING_RESULTS AS WITH DOI_MATCHES AS (SELECT
    t1.DOI AS DOI
FROM
    GESISNFRASER.UPW_14_NORM t1
INNER JOIN
    GESISNFRASER.WOS_12_17_NORM t2
ON
    t1.DOI = t2.DOI
    AND t1.ARTICLE_TYPE = 'journal-article'
    AND t2.ARTICLE_TYPE IN ('article', 'review'))
SELECT
    t1.*, t3.*
FROM
    GESISNFRASER.UPW_14_NORM t1
LEFT JOIN
    GESISNFRASER.UPW_14_NORM_ISSNS t2
ON
    t1.DOI = t2.DOI
INNER JOIN
    GESISNFRASER.WOS_12_17_NORM t3
ON
    t2.ISSN_VALUE = t3.JOURNAL_ISSNS
    AND t3.PUBYEAR <= (t1.PUBYEAR + 2)
    AND t1.AUTHORCOUNT = t3.AUTHORCOUNT
    AND t1.ARTICLE_TITLE NOT IN (SELECT ARTICLE_TITLE FROM UPW_14_TITLE_BLACKLIST)
    AND t3.ARTICLE_TITLE NOT IN (SELECT ARTICLE_TITLE FROM WOS_12_17_TITLE_BLACKLIST)
    AND UTL_MATCH.EDIT_DISTANCE_SIMILARITY(t1.ARTICLE_TITLE, t3.ARTICLE_TITLE) > 80
    AND t1.ARTICLE_TYPE = 'journal-article'
    AND t3.ARTICLE_TYPE IN ('article', 'review')
    AND t1.DOI NOT IN DOI_MATCHES.DOI
    AND t3.DOI NOT IN DOI_MATCHES.DOI
UNION
SELECT
    *
FROM
    GESISNFRASER.UPW_14_NORM t1
INNER JOIN
    GESISNFRASER.WOS_12_17_NORM t2
ON
    t1.DOI = t2.DOI
    AND t1.ARTICLE_TYPE = 'journal-article'
    AND t2.ARTICLE_TYPE IN ('article', 'review');
    